<div class="work-item-container">
  <h2 class="title" *ngIf="!isTemplatesMode">{{mode=='EPIC' ? 'Create new epic' : 'Create new work item'}}</h2>
  <h2 class="title" *ngIf="isTemplatesMode">Choose Template</h2>

  <div class="user-tag">
    <span class="icon">ðŸ‘¤</span>
    <span class="text">{{projectName}}</span>
  </div>

  <!-- Templates Interface -->
  <div *ngIf="isTemplatesMode">
    <!-- Templates Grid -->
    <div class="templates-grid">
      <div class="template-card" *ngFor="let template of filteredTemplates" (click)="selectTemplate(template)"
        [class.selected]="selectedTemplate?.id === template.id">
        <div class="template-icon" [style.background-color]="template.color">
          {{ template.icon }}
        </div>
        <div class="template-content">
          <h4 class="template-name">{{ template.name }}</h4>
          <p class="template-description">{{ template.description }}</p>

        </div>
        <div class="selected-badge" *ngIf="selectedTemplate?.id === template.id">
          <span class="material-icons">check</span>
        </div>
      </div>
    </div>

    <!-- Prompt and Actions -->
    <div class="prompt-section">
      <label class="prompt-label">Task Prompt:</label>
      <textarea [(ngModel)]="userPrompt" placeholder="Describe what you want to accomplish with this work item..."
        class="form-control" rows="4" maxlength="500">
      </textarea>
    </div>

    <div class="template-actions d-flex justify-content-center align-items-center">
      <button class="createAi_btn mt-2" (click)="useTemplate()" [disabled]="!selectedTemplate || !userPrompt.trim()">
        Generate with AI
      </button>
    </div>
  </div>

  <!-- Regular Form (when not in templates mode) -->
  <div class="d-flex flex-column gap-2" *ngIf="!isTemplatesMode">
    <div class="form-group">
      <input [(ngModel)]=work_title type="text" class="form-control" placeholder="Title">
    </div>

    <div class="form-group">
      <quill-editor
         [(ngModel)]="work_description"
          (onEditorCreated)="onEditorCreated($event)"
                  [modules]="quillModules"
                   class="description no-border-quill"
                  placeholder="Click to add description">
    </quill-editor>
      <div class="ai_button d-flex justify-content-end gap-2">
        <!-- <div class="surprise_btn add_templates_btn" *ngIf="work_title">
          <div (click)="openSurpriseMe()" class="d-flex justify-content-center align-items-center ">
            <div class="ai_icon">âœ¨
            </div>
            Surprise me
          </div>
        </div> -->
        <div class="add_templates_btn d-flex justify-content-center align-items-center" (click)="openTemplates()">
          âœ¨
        </div>
      </div>
    </div>

    <div class="custom-form d-flex flex-column gap-1" *ngIf="mode === 'EPIC'">
      <div class="form-row" *ngFor="let prop of customPropertiesList; let i = index">
        <div class="label-cell">
          <mat-icon>{{ getPropertyIcon(prop.propertyType?.value) }}</mat-icon>
          <span>{{ prop.title }}</span>
        </div>
    
        <ng-container [ngSwitch]="mapToFieldType(prop.propertyType?.value)">
          <!-- Text -->
          <mat-form-field *ngSwitchCase="'text'" appearance="outline" class="input-cell">
            <input matInput [(ngModel)]="prop.propertyType.attributeValue" [placeholder]="prop.title" />
          </mat-form-field>
    
          <!-- Select -->
          <mat-form-field *ngSwitchCase="'select'" appearance="outline" class="input-cell">
            <mat-select [(ngModel)]="prop.propertyType.attributeValue" [placeholder]="prop.title">
              <mat-option *ngFor="let opt of prop.propertyType?.attributeOptions" [value]="opt">{{ opt }}</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Number -->
          <mat-form-field *ngSwitchCase="'number'" appearance="outline" class="input-cell">
            <input type="number" matInput [(ngModel)]="prop.propertyType.attributeValue" [placeholder]="prop.title" />
          </mat-form-field>
    
          <!-- Date -->
          <mat-form-field *ngSwitchCase="'date'" appearance="outline" class="input-cell">
            <input matInput [matDatepicker]="picker" [(ngModel)]="prop.propertyType.attributeValue" />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </ng-container>
      </div>
    </div>








    <div class="actions-row w-100">
      <button class="action-btn" (click)="onStatus($event)">
        <span class="icon"><svg height="12px" width="12px" class="flex-shrink-0 h-100 w-100 flex-shrink-0"
            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 323.15 323.03">
            <g id="Layer_2" data-name="Layer 2">
              <g id="Layer_1-2" data-name="Layer 1">
                <path fill="#A3A3A3"
                  d="M163.42,322.92A172.12,172.12,0,0,1,104.8,312.7c-3.92-1.4-5.22-3.05-3.07-7.1,2.4-4.52,3-11.38,6.64-13.48s9.34,2.47,14.23,3.81c29.55,8.11,58.78,7.25,87.57-3.31,4.08-1.5,5.86-1.05,7.09,3.21a82.63,82.63,0,0,0,4.6,11c1.19,2.57,1,4.06-2,5.2a163.84,163.84,0,0,1-40.05,9.76C173.84,322.45,167.89,323.34,163.42,322.92Z">
                </path>
                <path fill="#A3A3A3"
                  d="M.07,163a174.76,174.76,0,0,1,10.07-58c1.59-4.57,3.53-5.59,7.8-3.2a61,61,0,0,0,10.11,4.19c3.11,1.06,4.07,2.46,2.71,5.79-6.43,15.73-9.17,32.33-9.23,49.14a132.65,132.65,0,0,0,8.17,47.35c2.44,6.5,2.33,6.57-4.06,9.35-3.35,1.45-6.83,2.63-10.11,4.23-2.44,1.19-3.54.49-4.43-1.86a162.3,162.3,0,0,1-10-41C.51,173.12-.24,167.17.07,163Z">
                </path>
                <path fill="#A3A3A3"
                  d="M323,160.16a169.68,169.68,0,0,1-10.2,58.09c-1.45,4.08-3.21,5.07-7.14,3a105.3,105.3,0,0,0-11.48-4.81c-2.23-.85-3.2-1.85-2.16-4.41a133.86,133.86,0,0,0,9.57-48.59,132,132,0,0,0-8.9-50.69c-1.67-4.24-.8-5.79,3.29-7a84,84,0,0,0,11-4.62c2.65-1.24,4.05-.82,5.16,2.12a159.68,159.68,0,0,1,9.68,39C322.56,148.71,323.52,155.17,323,160.16Z">
                </path>
                <path fill="#A3A3A3"
                  d="M161.59,0a164.28,164.28,0,0,1,58,10.72c2.81,1,3.75,2,2.41,4.93-2,4.38-3.86,8.84-5.5,13.37-.93,2.56-2.28,2.77-4.53,1.87a137.94,137.94,0,0,0-99.35-.52c-3.43,1.32-5.3,1.35-6.45-2.69a50.33,50.33,0,0,0-4.55-11c-2.25-3.93-.36-5.11,2.9-6.29A165.32,165.32,0,0,1,161.59,0Z">
                </path>
              </g>
            </g>
          </svg></span>
        <span class="status-text">
          <span>{{selectedStates?.name || 'States'}}</span>
          <span class="remove-btn" *ngIf="selectedStates?.length > 0" (click)="removeStates($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onPriority($event)">
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-ban flex-shrink-0 text-custom-text-200 flex-shrink-0 w-100 h-100">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="m4.9 4.9 14.2 14.2"></path>
          </svg></span>
        <span class="priority-text">
          <span>{{selectedPriority.name}}</span>
          <span class="remove-btn" *ngIf="selectedPriority.name !== 'None'" (click)="removePriority($event)">âœ•</span>
        </span>
      </button>
      <button class="action-btn" (click)="onEstimateTime($event)" *ngIf="feature?.estimations && mode !== 'EPIC'">
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-triangle h-3 w-3 flex-shrink-0">
            <path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
          </svg></span>
        <span class="priority-text">
          <span>{{ formatEstimatedTime() }}</span>
          <span class="remove-btn" *ngIf="selectedEstimatedTime" (click)="removeEstimatedTime($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onAssignee($event)">
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-users mx-[4px] flex-shrink-0 w-100 h-100">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg></span>
        <span class="assignee-text">
          <span>{{getAssigneesText()}}</span>
          <span class="remove-btn" *ngIf="selectedAssignees.length > 0" (click)="removeAllAssignees($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onLables($event)">
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-tag flex-shrink-0 w-100 h-100">
            <path
              d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z">
            </path>
            <circle cx="7.5" cy="7.5" r=".5" fill="currentColor"></circle>
          </svg></span>
        <span class="label-text">
          <span>{{getLabelsText()}}</span>
          <span class="remove-btn" *ngIf="selectedLabels.length > 0" (click)="removeAllLabels($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onStartDate($event)">
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-calendar-days flex-shrink-0 w-100 h-100">
            <path d="M8 2v4"></path>
            <path d="M16 2v4"></path>
            <rect width="18" height="18" x="3" y="4" rx="2"></rect>
            <path d="M3 10h18"></path>
          </svg></span>
        <span class="date-text">
          <span>{{formatDate(selectedStartDate, 'start')}}</span>
          <span class="remove-btn" *ngIf="selectedStartDate" (click)="removeStartDate($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onDueDate($event)">
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-calendar-days flex-shrink-0 w-100 h-100">
            <path d="M8 2v4"></path>
            <path d="M16 2v4"></path>
            <rect width="18" height="18" x="3" y="4" rx="2"></rect>
            <path d="M3 10h18"></path>
            <path d="M8 14h.01"></path>
            <path d="M12 14h.01"></path>
            <path d="M16 14h.01"></path>
            <path d="M8 18h.01"></path>
            <path d="M12 18h.01"></path>
            <path d="M16 18h.01"></path>
          </svg></span>
        <span class="date-text">
          <span>{{formatDate(selectedDueDate, 'due')}}</span>
          <span class="remove-btn" *ngIf="selectedDueDate" (click)="removeDueDate($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onCycle($event)" *ngIf="feature?.cycles && mode !== 'EPIC'">
        <span class="icon"><svg viewBox="0 0 24 24" class=" flex-shrink-0 stroke-2 w-100 h-100" stroke="currentColor"
            fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"
              stroke-linecap="round" stroke-linejoin="round"></path>
            <path
              d="M12 18C13.5913 18 15.1174 17.3679 16.2426 16.2426C17.3679 15.1174 18 13.5913 18 12C18 10.4087 17.3679 8.88258 16.2426 7.75736C15.1174 6.63214 13.5913 6 12 6V18Z"
              fill="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg></span>
        <span class="cycle-text">
          <span>{{selectedCycle?.name || 'Cycle'}}</span>
          <span class="remove-btn" *ngIf="selectedCycle" (click)="removeCycle($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onModule($event)" *ngIf="feature?.modules && mode !== 'EPIC'">
        <span class="icon"><svg viewBox="0 0 24 24" class=" flex-shrink-0 stroke-2 w-100 h-100 " stroke="currentColor"
            fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z"
              stroke-linecap="round" stroke-linejoin="round"></path>
            <path
              d="M8.77778 7H7.22222C7.09949 7 7 7.09949 7 7.22222V8.77778C7 8.90051 7.09949 9 7.22222 9H8.77778C8.90051 9 9 8.90051 9 8.77778V7.22222C9 7.09949 8.90051 7 8.77778 7Z"
              fill="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            <path
              d="M8.77778 15H7.22222C7.09949 15 7 15.0995 7 15.2222V16.7778C7 16.9005 7.09949 17 7.22222 17H8.77778C8.90051 17 9 16.9005 9 16.7778V15.2222C9 15.0995 8.90051 15 8.77778 15Z"
              fill="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            <path
              d="M16.7778 7H15.2222C15.0995 7 15 7.09949 15 7.22222V8.77778C15 8.90051 15.0995 9 15.2222 9H16.7778C16.9005 9 17 8.90051 17 8.77778V7.22222C17 7.09949 16.9005 7 16.7778 7Z"
              fill="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            <path
              d="M16.7778 15H15.2222C15.0995 15 15 15.0995 15 15.2222V16.7778C15 16.9005 15.0995 17 15.2222 17H16.7778C16.9005 17 17 16.9005 17 16.7778V15.2222C17 15.0995 16.9005 15 16.7778 15Z"
              fill="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg></span>
        <span class="module-text">
          <span>{{selectedModule?.name || 'Modules'}}</span>
          <span class="remove-btn" *ngIf="selectedModule" (click)="removeModule($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onAddParent ($event)" *ngIf="mode !== 'EPIC'">
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-layout-panel-top h-100 w-100 flex-shrink-0">
            <rect width="18" height="7" x="3" y="3" rx="1"></rect>
            <rect width="7" height="7" x="3" y="14" rx="1"></rect>
            <rect width="7" height="7" x="14" y="14" rx="1"></rect>
          </svg></span>
        <span class="parent-text">
          <span>{{selectedParent?.name || 'Add parent'}}</span>
          <span class="remove-btn" *ngIf="selectedParent" (click)="removeParent($event)">âœ•</span>
        </span>
      </button>

      <button class="action-btn" (click)="onAddAttachment($event)" *ngIf="mode !== 'EPIC'">
        <span class="icon">
          <img class="icon_img"
            src="https://d2z9497xp8xb12.cloudfront.net/prod-images/191188c1752930066305fi_8138518 (1).svg" alt="">
        </span>

        <span class="parent-text">
          <span>
            Add attachment
            <span *ngIf="selectedAttachmentName" class="file-name">
              â€” {{ selectedAttachmentName }}
            </span>
          </span>

          <span class="remove-btn" *ngIf="selectedAttachment" (click)="removeAttachment($event)">âœ•</span>
        </span>
      </button>

      <!-- hidden file input -->
      <input type="file" accept="image/*" style="display: none" #fileInput (change)="onFileSelected($event)" />
    </div>

    <div class="footer d-flex justify-content-end align-items-center gap-4">
      <div class="left">
        <label class="toggle-switch">
          <input type="checkbox" [(ngModel)]="isCreateMore">
          <span class="slider"></span>
        </label>
        <span class="toggle-label">Create more</span>
      </div>
      <div class="right">
        <button class="btn btn-secondary" (click)="onCancel()">Discard</button>
        <button class="btn save-btn" [disabled]="isSaving" (click)="onSave()">
          <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{isSaving ? 'Saving...' : 'Save'}}
        </button>
      </div>

    </div>
  </div>