<div class="main_section h-100">
    <div class="header d-flex justify-content-between align-items-center">
        <div class="left_side" (click)="onClose()">
            <mat-icon class="d-flex align-items-center justify-content-center cursor-pointer">close</mat-icon>
        </div>
        <div class="right_side d-flex align-items-center gap-1">
            <!-- <button class="action-btn unsub">
                <span class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-bell-off w-100 h-100">
                        <path d="M10.268 21a2 2 0 0 0 3.464 0"></path>
                        <path d="M17 17H4a1 1 0 0 1-.74-1.673C4.59 13.956 6 12.499 6 8a6 6 0 0 1 .258-1.742"></path>
                        <path d="m2 2 20 20"></path>
                        <path d="M8.668 3.01A6 6 0 0 1 18 8c0 2.687.77 4.653 1.707 6.05"></path>
                    </svg>
                </span>
                <span>Unsubscribe</span>
            </button>
            <button class="action-btn border-0">
                <span class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-link2 h-100 w-100 -rotate-45 text-custom-text-300 hover:text-custom-text-200">
                        <path d="M9 17H7A5 5 0 0 1 7 7h2"></path>
                        <path d="M15 7h2a5 5 0 1 1 0 10h-2"></path>
                        <line x1="8" x2="16" y1="12" y2="12"></line>
                    </svg>
                </span>
            </button> -->
            <button class="action-btn border-0 delete-btn" (click)="deleteWorkitem(data?.item)">
                <span class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-trash2 h-100 w-100 text-custom-text-300 hover:text-custom-text-200">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        <line x1="10" x2="10" y1="11" y2="17"></line>
                        <line x1="14" x2="14" y1="11" y2="17"></line>
                    </svg>
                </span>
            </button>
            <button class="action-btn border-0">
                <div class="icon" (click)="copyWorkitemLink()"
                    title="Copy Work Item Link to Clipboard" aria-label="Copy Work Item Link to Clipboard">
                   <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link2 h-4 w-4 -rotate-45 text-custom-text-300 hover:text-custom-text-200"><path d="M9 17H7A5 5 0 0 1 7 7h2"></path><path d="M15 7h2a5 5 0 1 1 0 10h-2"></path><line x1="8" x2="16" y1="12" y2="12"></line></svg>
                </div>
            </button>
            <button class="action-btn border-0" *ngIf="fromScreen === 'EPIC'" (click)="toggleEpicProperties($event)"
                aria-label="Toggle Epic Properties">
                <div class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-panel-left size-4 cursor-pointer">
                        <rect width="18" height="18" x="3" y="3" rx="2"></rect>
                        <path d="M9 3v18"></path>
                    </svg>
                </div>
            </button>
            <!-- <button class="action-btn border-0">
                <span class="icon">
                    <svg viewBox="0 0 24 24" class="size-4 flex-shrink-0 stroke-2 w-100 h-100" stroke="currentColor"
                        fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M21 3H3C2.44772 3 2 3.44772 2 4V7C2 7.55228 2.44772 8 3 8H21C21.5523 8 22 7.55228 22 7V4C22 3.44772 21.5523 3 21 3Z"
                            stroke-linecap="round" stroke-linejoin="round"></path>
                        <path d="M4 8V19C4 19.5304 4.21071 20.0391 4.58579 20.4142C4.96086 20.7893 5.46957 21 6 21H8"
                            stroke-linecap="round" stroke-linejoin="round"></path>
                        <path
                            d="M20 8V19C20 19.5304 19.7893 20.0391 19.4142 20.4142C19.0391 20.7893 18.5304 21 18 21H16"
                            stroke-linecap="round" stroke-linejoin="round"></path>
                        <path d="M15 18L12 21L9 18" stroke-linecap="round" stroke-linejoin="round"></path>
                        <path d="M12 21L12 12" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </span>
            </button> -->

            <!-- <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="deleteModalLabel">
                            <img src="https://d2z9497xp8xb12.cloudfront.net/prod-images/439988c1752592958469delete.svg" alt="">
                        Confirm Delete
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-3">
                        </div>
                        <h6 class="mb-3">Are you sure you want to delete this item?</h6>
                        <p class="text-muted">This action cannot be undone. The item will be permanently deleted.</p>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-secondary cancel-btn" data-bs-dismiss="modal">
                        Cancel
                        </button>
                        <button type="button" class="btn btn-danger w-20" (click)="deleteWorkItem(data?.item?.id)">
                        Delete
                        </button>
                    </div>
                    </div>
                </div>
                </div> -->
        </div>
    </div>

    <div class="detail_views">

        <div *ngIf="fromScreen!=null && fromScreen === 'EPIC'"
            [ngClass]="{'epic_section': true, 'epic-full': !showEpicProperties}">
            <div class="top_content d-flex flex-column p-3 gap-2">
                <div class="parent_workitem d-flex align-items-center gap-2"
                    *ngIf="data?.status === 'SUBWORKITEM_DETAIL'" (click)="onClose()"> <span>{{data?.bugNo}}</span>
                    <span>{{data?.title}}</span></div>
                <div class="bug_progress">
                    <div class="project_epic_id">{{ wholeData?.bugNo || 'N/A' }}</div>
                    <div class="circular">
                        <svg class="circle" viewBox="0 0 36 36">
                            <path class="circle-bg" d="M18 2.0845
                     a 15.9155 15.9155 0 0 1 0 31.831
                     a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle-progress" [attr.stroke-dasharray]="progress + ', 100'" d="M18 2.0845
                     a 15.9155 15.9155 0 0 1 0 31.831
                     a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="percentage">{{ progress }}%</div>
                    </div>

                </div>

                <div class="workitem_name" *ngIf="!isTitleEditing && !isDescriptionEditing" (click)="onTitleEdit()" style="cursor: pointer;">
                    {{wholeData?.title || 'Add title...'}}
                </div>
                <div class="workitem_name" *ngIf="isTitleEditing || isDescriptionEditing">
                    <input [(ngModel)]="tempTitle" placeholder="Enter title..." class="form-control"
                        (keydown.escape)="onTitleCancel()" #titleInput>
                </div>
                <div class="workitem_desc" *ngIf="!isDescriptionEditing && !isTitleEditing" (click)="onDescriptionEdit()"
                    style="white-space: pre-wrap;">
                    <ng-container
                        *ngIf="!showFullDescription && ((wholeData?.description || '')?.split('\n')?.length || 0) > 8">
                        <span [innerHTML]="getTruncatedDescription(wholeData?.description || '')"></span>...
                        <span class="read-more cursor-pointer" (click)="toggleDescription($event)">&nbsp;Read
                            more</span>
                    </ng-container>

                    <ng-container
                        *ngIf="showFullDescription || ((wholeData?.description || '')?.split('\n')?.length || 0) <= 8">
                        <span [innerHTML]="wholeData?.description || 'Add description...'"></span>
                        <span class="read-less cursor-pointer"
                            *ngIf="showFullDescription && ((wholeData?.description || '')?.split('\n')?.length || 0) > 8"
                            (click)="toggleDescription($event)">&nbsp; Read less</span>
                    </ng-container>
                </div>

                <div class="workitem_desc" *ngIf="isTitleEditing || isDescriptionEditing">
                    <quill-editor
                        [(ngModel)]="tempDescription"
                        (onEditorCreated)="onEpicDescriptionEditorCreated($event)"
                        [modules]="epicDescriptionModules"
                        class="epic-description-quill"
                        placeholder="Enter description...">
                    </quill-editor>
                </div>

                <div class="d-flex gap-2 mt-2" *ngIf="isTitleEditing || isDescriptionEditing">
                    <button class="btn btn-sm save-btn" (click)="onEpicTitleSave(); onEpicDescriptionSave()">Save</button>
                    <button class="btn btn-secondary btn-sm cancel-btn"
                        (click)="onTitleCancel(); onDescriptionCancel()">Cancel</button>
                </div>
                <div class="project_last_edit d-flex justify-content-end align-items-center">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-history size-3.5 w-100 h-100 d-flex">
                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                            <path d="M3 3v5h5"></path>
                            <path d="M12 7v5l4 2"></path>
                        </svg>
                    </span>
                    Last edited by {{latestChangeData?.user?.name}} about
                    {{getRelativeTime(latestChangeData?.timestamp)}}
                </div>

                <div class="progress-container" *ngIf="epicWorkitemList?.length > 0">
                    <div class="progress-header">
                        <span class="title">Progress</span>

                    </div>

                    <div class="progress-bar">
                        <ng-container *ngFor="let p of progressItems">
                            <!-- render segment only when there's a non-zero percent -->
                            <div *ngIf="(p.percent || 0) > 0" class="progress-segment {{p.class}}" [style.width.%]="p.percent"></div>
                        </ng-container>
                    </div>
                    <div class="progress-legend">
                        <div class="legend-grid d-flex gap-3 justify-content-between">
                            <div class="legend-card" *ngFor="let p of progressItems">
                                <div class="legend-top d-flex align-items-center gap-2">
                                    <!-- color chip that matches the progress segment color -->
                                    <div class="legend-color {{p.class}}" role="img"
                                        [attr.aria-label]="p.label + ' color'"></div>
                                    <div class="legend-label">{{ p.label }}</div>
                                </div>
                                <div class="legend-stats w-100 d-flex flex-column align-items-start">
                                    <div class="legend-count">{{ p.count }}</div>
                                    <div class="legend-percent">{{ p.percent }}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="actions d-flex gap-3 align-items-center">
                    <!-- <button (click)="addSubWorkItem($event)" class="action-btn">
        <img class="icon_img" src="https://d2z9497xp8xb12.cloudfront.net/prod-images/510004c1752929821563Icon.svg"
            alt=""> Add sub-work item
    </button> -->

                    <div class="change_cover_wrapper">
                        <button (click)="fileInput.click()" class="action-btn">
                            <img class="icon_img"
                                src="https://d2z9497xp8xb12.cloudfront.net/prod-images/191188c1752930066305fi_8138518 (1).svg"
                                alt="">
                            Attach
                        </button>

                        <input #fileInput type="file" name="myfile"
                            accept="image/x-png,image/jpeg,image/jpg,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/csv,application/csv,video/mp4,video/avi,video/mov,video/wmv,video/flv,video/webm,video/mkv,video/3gp,video/ogv"
                            style="display: none" (change)="onFileSelected($event)" />
                    </div>
                    <!-- <button (click)="addSubWorkItem($event)" class="action-btn">
        <img class="icon_img" src="https://d2z9497xp8xb12.cloudfront.net/prod-images/510004c1752929821563Icon.svg"
            alt=""> Link pages
    </button> -->
                </div>
                <div class="subWorkItem_Section" *ngIf="attachmentsList?.length > 0">
                    <div class="sub-workitems-header d-flex justify-content-between align-items-center"
                        (click)="toggleAttachments()">
                        <div class="d-flex align-items-center gap-2">
                            <mat-icon class="expand-icon" [class.expanded]="isAttachmentsExpanded">
                                {{isAttachmentsExpanded ? 'expand_more' : 'chevron_right'}}
                            </mat-icon>
                            <span class="section-title">Attachments</span>
                            <span class="count-badge">{{attachmentsList.length}}</span>
                        </div>
                        <button class="add-subitem-btn" (click)="$event.stopPropagation(); fileInput.click()">
                            <mat-icon>add</mat-icon>
                        </button>
                    </div>

                    <div class="sub-workitems-list" *ngIf="isAttachmentsExpanded">
                        <div class="attachment-card d-flex align-items-center justify-content-between p-3 mb-2"
                            *ngFor="let attachment of attachmentsList; let i = index">
                            <div class="left_side d-flex align-items-center gap-3"
                                (click)="handleAttachmentClick(attachment)" style="cursor: pointer;">
                                <div class="file-icon">
                                    <mat-icon *ngIf="isImageFile(attachment.name)">image</mat-icon>
                                    <mat-icon *ngIf="isPdfFile(attachment.name)">picture_as_pdf</mat-icon>
                                    <mat-icon *ngIf="isVideoFile(attachment.name)">play_circle_filled</mat-icon>
                                    <mat-icon *ngIf="isDocFile(attachment.name)">description</mat-icon>
                                    <mat-icon *ngIf="isCsvFile(attachment.name)">table_chart</mat-icon>
                                    <mat-icon
                                        *ngIf="!isImageFile(attachment.name) && !isPdfFile(attachment.name) && !isVideoFile(attachment.name) && !isDocFile(attachment.name) && !isCsvFile(attachment.name)">attach_file</mat-icon>
                                </div>
                                <div class="file-info cursor-pointer">
                                    <div class="file-name" style="cursor: pointer;">
                                        {{attachment?.name || 'Unnamed File' }}
                                    </div>
                                    <div class="file-meta text-muted small">
                                        Uploaded by {{attachment?.staff?.name || 'Unknown' || attachment?.uploadedBy}} •
                                        {{getRelativeTime(attachment?.date)}}
                                    </div>
                                </div>
                            </div>
                            <div class="right_side d-flex align-items-center gap-2">
                                <button class="remove-btn border-0 bg-transparent"
                                    (click)="removeAttachment(attachment)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                                <!-- <button class="btn btn-sm btn-outline-primary">
                            <mat-icon>download</mat-icon>
                        </button> -->
                                <!-- <button class="btn btn-sm btn-outline-danger" (click)="removeAttachment(i)">
                            <mat-icon>delete</mat-icon>
                        </button> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="workItems_list">
                <div class="overview_header mb-1 d-flex align-items-center justify-content-between">
                    <div class="overview_title">Overview</div>
                    <div class="add_workitem" *ngIf="epicWorkitemList?.length > 0" (click)="addWorkItemInEpic($event)"><mat-icon>add</mat-icon></div>
                </div>
                <div class="item_list">
                    <div class="add_workitem_section" *ngIf="epicWorkitemList?.length === 0">
                        <div
                            class="empty-workitems d-flex flex-column align-items-center justify-content-center text-center p-4">
                            <div class="empty-icon mb-3" aria-hidden="true">
                                <!-- simple placeholder icon matching screenshot -->
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" class="opacity-60">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"
                                        stroke="#b0b7c3" stroke-width="1.2" />
                                    <path d="M8 12h8M8 16h8" stroke="#b0b7c3" stroke-width="1.2"
                                        stroke-linecap="round" />
                                </svg>
                            </div>
                            <div class="empty-title fw-bold mb-1">No work items yet</div>
                            <div class="empty-subtext text-muted mb-3">Start adding work items to manage and track the
                                progress of the epic.</div>
                            <button class="add-workitems-btn " (click)="addWorkItemInEpic($event)">Add work
                                items</button>
                        </div>
                    </div>
                    <ng-container *ngIf="epicWorkitemList?.length > 0">
                        <div *ngFor="let item of epicWorkitemList" class="item_card" (click)="detailEpic(item)">
                            <div class="left_section">
                                <div class="bug_no">{{ item.displayBugNo }}</div>
                                <div class="item_title">{{ item.title }}</div>
                            </div>
                            <div class="right_section">

                                <div class="issue_state common-style d-flex align-items-center gap-1 border-0">
                                    <img [src]="getIconForState(item?.state?.name)" width="16" height="16"
                                        alt="{{ item?.state?.name || 'No State' }}" />
                                    <!-- <span>{{item?.state?.name}}</span> -->
                                </div>
                                <div class="priority d-flex align-items-center gap-1 border-0">
                                    <img class="img" [src]="getIconForPriority(item?.priority)" width="16" height="16"
                                        alt="{{ item?.priority || 'None' }}" />
                                </div>

                                <div class="start-date common-style d-flex align-items-center gap-1 cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="lucide lucide-calendar-clock h-3 w-3 flex-shrink-0">
                                        <path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"></path>
                                        <path d="M16 2v4"></path>
                                        <path d="M8 2v4"></path>
                                        <path d="M3 10h5"></path>
                                        <path d="M17.5 17.5 16 16.3V14"></path>
                                        <circle cx="16" cy="16" r="6"></circle>
                                    </svg>
                                    <span class="date-text">{{ (item?.startDate | date: 'MMM d y') }}</span>
                                </div>

                                <div class="end-date common-style d-flex align-items-center gap-1 cursor-pointer me-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="lucide lucide-calendar-check2 h-3 w-3 flex-shrink-0">
                                        <path d="M8 2v4"></path>
                                        <path d="M16 2v4"></path>
                                        <path d="M21 14V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"></path>
                                        <path d="M3 10h18"></path>
                                        <path d="m16 20 2 2 4-4"></path>
                                    </svg>
                                    <span class="date-text">{{ (item?.endDate | date: 'MMM d y') }}</span>
                                </div>

                                <div class="assignee d-flex align-items-center">
                                    <!-- <div class="avatar">{{item.assignee?.name?.charAt(0)}}</div> -->
                                    <ng-container *ngIf="item?.assignee?.length === 1">
                                        <div class="assignee-single d-flex align-items-center justify-content-center">
                                            <div class="avatar">{{ getInitial(item.assignee[0]?.name) }}</div>
                                            <!-- <span class="assignee-name">{{ item.assignee[0]?.name }}</span> -->
                                        </div>
                                    </ng-container>

                                    <ng-container *ngIf="item?.assignee?.length > 1">
                                        <div
                                            class="assignee-multiple d-flex align-items-center justify-content-center gap-1">
                                            <div class="avatar" *ngFor="let user of item.assignee">
                                                {{ getInitial(user?.name) }}
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>

                                <div class="more-options-container">
                                    <button class="more-btn" matButton [matMenuTriggerFor]="menu" (click)="$event.stopPropagation()">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>

                                    <mat-menu #menu="matMenu">
                                        <button mat-menu-item data-bs-toggle="modal" data-bs-target="#deleteModal" (click)="$event.stopPropagation(); removeWorkitemFromEpic(item.id)">
                                            <div class="delete d-flex align-items-center gap-2"><i
                                                    class="material-icons">delete</i> Delete
                                            </div>
                                        </button>
                                    </mat-menu>
                                </div>

                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>

        </div>


        <div class="workItem_sections" [ngStyle]="{
    width: fromScreen === 'EPIC' ? '45%' : '100%',
    display: (fromScreen === 'EPIC' && !showEpicProperties) ? 'none' : 'block'
  }">
            <ng-container *ngIf="fromScreen === 'WORK_ITEM' || data?.status === 'SUBWORKITEM_DETAIL'">
                <div class="top_content d-flex flex-column p-3 gap-2">
                    <div class="parent_workitem d-flex align-items-center gap-2"
                        *ngIf="data?.status === 'SUBWORKITEM_DETAIL'" (click)="onClose()"> <span>{{data?.bugNo}}</span>
                        <span>{{data?.title}}</span></div>
                    <div class="project_workitem_id">{{ wholeData?.displayBugNo || 'N/A' }}</div>
                    <div class="workitem_name" *ngIf="!isTitleEditing && !isDescriptionEditing" (click)="onTitleEdit()" style="cursor: pointer;">
                        {{wholeData?.title || 'Add title...'}}
                    </div>
                    <div class="workitem_name" *ngIf="isTitleEditing || isDescriptionEditing">
                        <input [(ngModel)]="tempTitle" placeholder="Enter title..." class="form-control"
                            (keydown.escape)="onTitleCancel()" #titleInput>
                    </div>
                    <div class="workitem_desc" *ngIf="!isDescriptionEditing && !isTitleEditing" (click)="onDescriptionEdit()"
                        style="white-space: pre-wrap;">
                        <ng-container
                            *ngIf="!showFullDescription && ((wholeData?.description || '')?.split('\n')?.length || 0) > 8">
                            <span [innerHTML]="getTruncatedDescription(wholeData?.description || '')"></span>...
                            <span class="read-more cursor-pointer" (click)="toggleDescription($event)">&nbsp;Read
                                more</span>
                        </ng-container>

                        <ng-container
                            *ngIf="showFullDescription || ((wholeData?.description || '')?.split('\n')?.length || 0) <= 8">
                            <span [innerHTML]="wholeData?.description || 'Add description...'"></span>
                            <span class="read-less cursor-pointer"
                                *ngIf="showFullDescription && ((wholeData?.description || '')?.split('\n')?.length || 0) > 8"
                                (click)="toggleDescription($event)">&nbsp; Read less</span>
                        </ng-container>
                    </div>

                    <div class="workitem_desc" *ngIf="isTitleEditing || isDescriptionEditing">
                        <quill-editor
                            [(ngModel)]="tempDescription"
                            (onEditorCreated)="onWorkItemDescriptionEditorCreated($event)"
                            [modules]="epicDescriptionModules"
                            class="workitem-description-quill"
                            placeholder="Enter description...">
                        </quill-editor>
                    </div>

                    <div class="d-flex gap-2 mt-2" *ngIf="isTitleEditing || isDescriptionEditing">
                        <button class="btn btn-sm save-btn" (click)="onTitleSave(); onDescriptionSave()">Save</button>
                        <button class="btn btn-secondary btn-sm cancel-btn"
                            (click)="onTitleCancel(); onDescriptionCancel()">Cancel</button>
                    </div>
                    <div class="project_last_edit d-flex justify-content-end align-items-center">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-history size-3.5 w-100 h-100 d-flex">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                <path d="M3 3v5h5"></path>
                                <path d="M12 7v5l4 2"></path>
                            </svg>
                        </span>
                        Last edited by {{latestChangeData?.user?.name}} about
                        {{getRelativeTime(latestChangeData?.timestamp)}}
                    </div>
                    <div class="actions d-flex gap-3 align-items-center">
                        <button (click)="addSubWorkItem($event)" class="action-btn">
                            <img class="icon_img"
                                src="https://d2z9497xp8xb12.cloudfront.net/prod-images/510004c1752929821563Icon.svg"
                                alt=""> Add
                            sub-work item
                        </button>
                        <!-- <button (click)="addRelationDialog($event,selectedWorkItem)" class="action-btn">
                <img class="icon_img" src="https://d2z9497xp8xb12.cloudfront.net/prod-images/442999c1752929947969fi_3505833.svg" alt="">  Add relation
                </button> -->
                        <!-- <button (click)="addLinkDialog($event)"  type="button" class="action-btn">
                <img class="icon_img" src="https://d2z9497xp8xb12.cloudfront.net/prod-images/424077c1752929988046fi_659999 (1).svg" alt="">Add link
                </button> -->

                        <div class="change_cover_wrapper">
                            <button (click)="fileInput.click()" class="action-btn">
                                <img class="icon_img"
                                    src="https://d2z9497xp8xb12.cloudfront.net/prod-images/191188c1752930066305fi_8138518 (1).svg"
                                    alt=""> Attach
                            </button>

                            <input #fileInput type="file" name="myfile"
                                accept="image/x-png,image/jpeg,image/jpg,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/csv,application/csv,video/mp4,video/avi,video/mov,video/wmv,video/flv,video/webm,video/mkv,video/3gp,video/ogv"
                                style="display: none" (change)="onFileSelected($event)" />
                        </div>
                    </div>
                    <!-- <div class="add-btns d-flex gap-2 mt-2">
                <button class="action-btn">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-layers h-100 w-100 flex-shrink-0">
                            <path
                                d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z">
                            </path>
                            <path d="M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12"></path>
                            <path d="M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17"></path>
                        </svg>
                    </span>
                    <span>Add sub-work item</span>
                </button>
                <button class="action-btn">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-waypoints h-100 w-100 flex-shrink-0">
                            <circle cx="12" cy="4.5" r="2.5"></circle>
                            <path d="m10.2 6.3-3.9 3.9"></path>
                            <circle cx="4.5" cy="12" r="2.5"></circle>
                            <path d="M7 12h10"></path>
                            <circle cx="19.5" cy="12" r="2.5"></circle>
                            <path d="m13.8 17.7 3.9-3.9"></path>
                            <circle cx="12" cy="19.5" r="2.5"></circle>
                        </svg>
                    </span>
                    <span>Add relation</span>
                </button>
                <button class="action-btn">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-link h-100 w-100 flex-shrink-0">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                    </span>
                    <span>Add link</span>
                </button>
                <button class="action-btn">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-paperclip h-100 w-100 flex-shrink-0">
                            <path d="M13.234 20.252 21 12.3"></path>
                            <path
                                d="m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486">
                            </path>
                        </svg>
                    </span>
                    <span>Attach</span>
                </button>
            </div> -->
                </div>

                <div class="subWorkItem_Section" *ngIf="subWorkItemList.length > 0">
                    <div class="sub-workitems-header d-flex justify-content-between align-items-center"
                        (click)="toggleSubWorkItems()">
                        <div class="d-flex align-items-center gap-2">
                            <mat-icon class="expand-icon" [class.expanded]="isSubWorkItemsExpanded">
                                {{isSubWorkItemsExpanded ? 'expand_more' : 'chevron_right'}}
                            </mat-icon>
                            <span class="section-title">Sub-work items</span>
                            <div class="progress-indicator">
                                <span class="progress-icon">
                                    <svg viewBox="0 0 24 24" width="16" height="16" class="progress-moon">
                                        <path
                                            d="M10.5 1.5C5.81 1.5 2 5.31 2 10s3.81 8.5 8.5 8.5 8.5-3.81 8.5-8.5-3.81-8.5-8.5-8.5zm0 15c-3.59 0-6.5-2.91-6.5-6.5S6.91 3 10.5 3 17 5.91 17 9.5 14.09 16.5 10.5 16.5z" />
                                    </svg>
                                </span>
                                {{getCompletedCount()}}/{{subWorkItemList.length}} Done
                            </div>
                        </div>
                        <button class="add-subitem-btn" (click)="$event.stopPropagation(); addSubWorkItem($event)">
                            <mat-icon>add</mat-icon>
                        </button>
                    </div>

                    <div class="sub-workitems-list" *ngIf="isSubWorkItemsExpanded">
                        <div class="issue_card d-flex align-items-center justify-content-between"
                            *ngFor="let item of subWorkItemList; let i = index" (click)="detailWorkitem(item)">
                            <div class="left_side d-flex align-items-center gap-2">
                                <div class="status-indicator" [class.completed]="item.state?.name === 'Done'">
                                    <!-- <mat-icon>check_circle</mat-icon> -->
                                </div>
                                <div class="issue_no">{{item.displayBugNo}}</div>
                                <div class="issue_desc">{{item.title}}</div>
                            </div>
                            <div class="right_side d-flex align-items-center gap-3 justify-content-end">
                                <div class="issue_state common-style d-flex align-items-center gap-1">
                                    <!-- <img [src]="getIconForState(item?.state?.name)" width="16" height="16" 
                                alt="{{ item?.state?.name || 'No State' }}" /> -->
                                    <span>{{item?.state?.name}}</span>
                                </div>
                                <div class="priority d-flex align-items-center gap-1">
                                    <img class="img" [src]="getIconForPriority(item?.priority)" width="16" height="16"
                                        alt="{{ item?.priority || 'None' }}" />
                                </div>
                                <div class="assignee d-flex align-items-center">
                                    <!-- <div class="avatar">{{item.assignee?.name?.charAt(0)}}</div> -->
                                    <ng-container *ngIf="item?.assignee?.length === 1">
                                        <div class="assignee-single d-flex align-items-center justify-content-center">
                                            <div class="avatar">{{ getInitial(item.assignee[0]?.name) }}</div>
                                            <!-- <span class="assignee-name">{{ item.assignee[0]?.name }}</span> -->
                                        </div>
                                    </ng-container>

                                    <ng-container *ngIf="item?.assignee?.length > 1">
                                        <div
                                            class="assignee-multiple d-flex align-items-center justify-content-center gap-1">
                                            <div class="avatar" *ngFor="let user of item.assignee">
                                                {{ getInitial(user?.name) }}
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>
                                <div class="more-options-container">
                                    <button class="more-btn" (click)="toggleMoreOptions($event, i)" matButton
                                        [matMenuTriggerFor]="menu">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <mat-menu #menu="matMenu">
                                        <button mat-menu-item (click)="removeSubWorkItem(item)">
                                            <div class="edit d-flex align-items-center gap-2">Remove</div>
                                        </button>
                                        <!-- <button mat-menu-item  data-bs-toggle="modal" data-bs-target="#deleteModal3">
                                <div class="delete d-flex align-items-center gap-2"><i class="material-icons">delete</i> Delete</div>
                            </button> -->
                                    </mat-menu>
                                </div>
                                <div class="modal fade" id="deleteModal3" tabindex="-1" aria-labelledby="deleteModalSub"
                                    aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header border-0">
                                                <h5 class="modal-title" id="deleteModalSub">
                                                    <img src="https://d2z9497xp8xb12.cloudfront.net/prod-images/439988c1752592958469delete.svg"
                                                        alt="">
                                                    Confirm Delete
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <div class="mb-3">
                                                </div>
                                                <h6 class="mb-3">Are you sure you want to delete this item?</h6>
                                                <p class="text-muted">This action cannot be undone. The item will be
                                                    permanently
                                                    deleted.</p>
                                            </div>
                                            <div class="modal-footer border-0">
                                                <button type="button" class="btn btn-secondary cancel-btn"
                                                    data-bs-dismiss="modal">
                                                    Cancel
                                                </button>
                                                <button type="button" class="btn btn-danger w-20"
                                                    (click)="deleteWorkitem(item.id)">
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="subWorkItem_Section" *ngIf="attachmentsList?.length > 0">
                    <div class="sub-workitems-header d-flex justify-content-between align-items-center"
                        (click)="toggleAttachments()">
                        <div class="d-flex align-items-center gap-2">
                            <mat-icon class="expand-icon" [class.expanded]="isAttachmentsExpanded">
                                {{isAttachmentsExpanded ? 'expand_more' : 'chevron_right'}}
                            </mat-icon>
                            <span class="section-title">Attachments</span>
                            <span class="count-badge">{{attachmentsList.length}}</span>
                        </div>
                        <button class="add-subitem-btn" (click)="$event.stopPropagation(); fileInput.click()">
                            <mat-icon>add</mat-icon>
                        </button>
                    </div>

                    <div class="sub-workitems-list" *ngIf="isAttachmentsExpanded">
                        <div class="attachment-card d-flex align-items-center justify-content-between p-3 mb-2"
                            *ngFor="let attachment of attachmentsList; let i = index">
                            <div class="left_side d-flex align-items-center gap-3"
                                (click)="handleAttachmentClick(attachment)" style="cursor: pointer;">
                                <div class="file-icon">
                                    <mat-icon *ngIf="isImageFile(attachment.name)">image</mat-icon>
                                    <mat-icon *ngIf="isPdfFile(attachment.name)">picture_as_pdf</mat-icon>
                                    <mat-icon *ngIf="isVideoFile(attachment.name)">play_circle_filled</mat-icon>
                                    <mat-icon *ngIf="isDocFile(attachment.name)">description</mat-icon>
                                    <mat-icon *ngIf="isCsvFile(attachment.name)">table_chart</mat-icon>
                                    <mat-icon
                                        *ngIf="!isImageFile(attachment.name) && !isPdfFile(attachment.name) && !isVideoFile(attachment.name) && !isDocFile(attachment.name) && !isCsvFile(attachment.name)">attach_file</mat-icon>
                                </div>
                                <div class="file-info cursor-pointer">
                                    <div class="file-name" style="cursor: pointer;">
                                        {{attachment?.name || 'Unnamed File' }}
                                    </div>
                                    <div class="file-meta text-muted small">
                                        Uploaded by {{attachment?.staff?.name || 'Unknown' || attachment?.uploadedBy}} •
                                        {{getRelativeTime(attachment?.date)}}
                                    </div>
                                </div>
                            </div>
                            <div class="right_side d-flex align-items-center gap-2">
                                <button class="remove-btn border-0 bg-transparent"
                                    (click)="removeAttachment(attachment)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                                <!-- <button class="btn btn-sm btn-outline-primary">
                            <mat-icon>download</mat-icon>
                        </button> -->
                                <!-- <button class="btn btn-sm btn-outline-danger" (click)="removeAttachment(i)">
                            <mat-icon>delete</mat-icon>
                        </button> -->
                            </div>
                        </div>
                    </div>
                </div>
            </ng-container>

            <div class="epicProperties properties p-3" *ngIf="fromScreen === 'EPIC' ">
                <ng-container *ngIf="fromScreen === 'EPIC' && showEpicProperties">
                    <div class="epicProperty h-100">
                        <div class="custom-tab-bar">
                            <div class="tab-item" [ngClass]="{ selected: selectedTab === 0 }" (click)="selectedTab = 0">
                                <mat-icon class="tab_icon">info</mat-icon>
                            </div>
                            <div class="tab-item" [ngClass]="{ selected: selectedTab === 1 }" (click)="selectedTab = 1">
                                <mat-icon class="tab_icon">rocket_launch</mat-icon>
                            </div>
                            <div class="tab-item" [ngClass]="{ selected: selectedTab === 2 }" (click)="selectedTab = 2">
                                <mat-icon class="tab_icon">chat</mat-icon>
                            </div>
                            <!-- <div class="tab-item" [ngClass]="{ selected: selectedTab === 3 }" (click)="selectedTab = 3">
                                <svg class="tab_icon" xmlns="http://www.w3.org/2000/svg" height="18px"
                                    viewBox="0 -960 960 960" width="18px" fill="#1f1f1f">
                                    <path
                                        d="M360-160q-19 0-34-11t-22-28l-92-241H40v-80h228l92 244 184-485q7-17 22-28t34-11q19 0 34 11t22 28l92 241h172v80H692l-92-244-184 485q-7 17-22 28t-34 11Z" />
                                </svg>
                            </div> -->
                        </div>
                        <!-- selectedTab = 0 -->
                        <ng-container *ngIf="selectedTab === 0">
                            <h3 class="properties-title mt-2 mb-3">Properties</h3>
                            <div class="properties-list d-flex flex-column gap-3">
                                <div class="property-item d-flex align-items-center gap-2" (click)="onStateEdit($event)"
                                    style="cursor: pointer;">
                                    <mat-icon>radio_button_checked</mat-icon>
                                    <span class="property-label">State</span>
                                    <span class="property-value">{{ wholeData?.state?.name || 'N/A' }}</span>
                                </div>
                                <ng-template #noAssignee>
                                    <div class="property-item d-flex align-items-center gap-2"
                                        (click)="onAssigneeEdit($event)" style="cursor: pointer;">
                                        <mat-icon>person</mat-icon>
                                        <span class="property-label">Assignees</span>
                                        <span class="property-value text-muted">No assignees</span>
                                    </div>
                                </ng-template>
                                <div class="property-item d-flex align-items-center gap-2"
                                    *ngIf="wholeData?.assignee?.length; else noAssignee"
                                    (click)="onAssigneeEdit($event)" style="cursor: pointer;">
                                    <mat-icon>person</mat-icon>
                                    <span class="property-label">Assignees</span>
                                    <div class="assignee-list d-flex flex-wrap gap-1">
                                        <span class="assignee-tag" *ngFor="let assignee of wholeData.assignee">
                                            {{assignee.name}}
                                            <span class="remove-icon"
                                                (click)="removeAssignee(assignee, $event)">×</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="property-item d-flex align-items-center gap-2"
                                    (click)="onPriorityEdit($event)" style="cursor: pointer;">
                                    <mat-icon>signal_cellular_alt</mat-icon>
                                    <span class="property-label">Priority</span>
                                    <span class="property-value">{{ wholeData?.priority || 'None' }}</span>
                                </div>
                                <div class="property-item d-flex align-items-center gap-2">
                                    <mat-icon>person_outline</mat-icon>
                                    <span class="property-label">Created by</span>
                                    <div class="user-info d-flex align-items-center gap-2">
                                        <div class="user-avatar">{{getInitial(wholeData?.createdBy?.name)}}</div>
                                        <span>{{wholeData?.createdBy?.name || 'None'}}</span>
                                    </div>
                                </div>
                                <div class="property-item d-flex align-items-center gap-2"
                                    (click)="onStartDateEdit($event)" style="cursor: pointer;">
                                    <mat-icon>calendar_today</mat-icon>
                                    <span class="property-label">Start date</span>
                                    <span class="property-value">{{ (wholeData?.startDate | date: 'MMM d y') || 'None'
                                        }}</span>
                                </div>
                                <div class="property-item d-flex align-items-center gap-2"
                                    (click)="onDueDateEdit($event)" style="cursor: pointer;">
                                    <mat-icon>event</mat-icon>
                                    <span class="property-label">Due date</span>
                                    <span class="property-value text-danger">{{ (wholeData?.endDate | date: 'MMM d y')
                                        || 'None'
                                        }}</span>
                                </div>
                                <!-- <div *ngIf="feature?.modules" class="property-item d-flex align-items-center gap-2"
                                    (click)="onModuleEdit($event)" style="cursor: pointer;">
                                    <mat-icon>dashboard</mat-icon>
                                    <span class="property-label">Modules</span>
                                    <span class="property-value text-muted">{{ wholeData?.modules?.name || 'None'
                                        }}</span>
                                </div> -->
                                <!-- <div *ngIf="feature?.cycles" class="property-item d-flex align-items-center gap-2"
                                    (click)="onCycleEdit($event)" style="cursor: pointer;">
                                    <mat-icon>refresh</mat-icon>
                                    <span class="property-label">Cycle</span>
                                    <span class="property-value text-muted">{{ wholeData?.cycle?.name || 'None'
                                        }}</span>
                                </div> -->
                                <!-- <div class="property-item d-flex align-items-center gap-2" (click)="onParentEdit($event)" style="cursor: pointer;">
                                    <mat-icon>account_tree</mat-icon>
                                    <span class="property-label">Parent</span>
                                    <span class="property-value text-muted">{{ wholeData?.parent || 'Add parent work item' }}</span>
                                </div> -->
                                <div class="property-item d-flex align-items-center gap-2" (click)="onLabelEdit($event)"
                                    style="cursor: pointer;">
                                    <mat-icon>label</mat-icon>
                                    <span class="property-label">Labels</span>
                                    <div class="labels-list d-flex flex-wrap gap-1">
                                        <span *ngFor="let label of wholeData?.label" class="label-tag">
                                            {{label?.name || label?.label}}
                                            <span class="remove-icon" (click)="removeLabel(label, $event)">×</span>
                                        </span>
                                        <span *ngIf="!wholeData?.label || wholeData?.label?.length === 0"
                                            class="no-label">
                                            None
                                        </span>
                                    </div>
                                </div>
                                <!-- <div *ngIf="feature?.estimations" class="property-item d-flex align-items-center gap-2"
                                    (click)="onEstimateTime($event)" style="cursor: pointer;">
                                    <mat-icon>schedule</mat-icon>
                                    <span class="property-label">Estimate</span>
                                    <span class="property-value">{{ formatEstimatedList(wholeData?.estimate) || 'None'
                                        }}</span>
                                </div> -->
                                <!-- <div *ngIf="feature?.timeTracking" class="property-item d-flex align-items-center gap-2"
                                    style="cursor: pointer;">
                                    <mat-icon>timer</mat-icon>
                                    <span class="property-label">Time Tracking</span>
                                    <span class="property-value">{{totalTime}}</span>
                                </div> -->
                                <div class="property-item">
                                    <div class="custom-form d-flex flex-column gap-1">
                                        <div class="form-row w-100 d-flex align-items-center" *ngFor="let property of wholeData?.customProperties">
                                            <div class="label-cell w-50 d-flex align-items-center gap-1">
                                                <mat-icon>{{ getPropertyIcon(property.propertyType.value) }}</mat-icon>
                                                <span class="property-label">{{ property.title | titlecase  }}</span>
                                                <span class="required" *ngIf="property.mandatory">*</span>
                                            </div>
                                
                                            <ng-container [ngSwitch]="property.propertyType.value">
                                                <!-- Text Input -->
                                                <mat-form-field *ngSwitchCase="'text'" appearance="outline" class="input-cell">
                                                    <input
                                                    (keydown.enter)="updatePropertyType(property)"
                                                     matInput [placeholder]="property.propertyType.attributeValue || ''"
                                                        [(ngModel)]="property.propertyType.attributeValue" />
                                                </mat-form-field>
                                
                                                <!-- Dropdown -->
                                                <mat-form-field *ngSwitchCase="'droopdown'" appearance="outline" class="input-cell">
                                                    <mat-select [placeholder]="property.description || ''"
                                                        [(ngModel)]="property.propertyType.attributeValue">
                                                        <mat-option *ngFor="let opt of property.propertyType.attributeOptions" [value]="opt">
                                                            {{ opt }}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                
                                                <!-- Date -->
                                                <mat-form-field *ngSwitchCase="'date'" appearance="outline" class="input-cell">
                                                    <input matInput [matDatepicker]="picker" [(ngModel)]="property.propertyType.attributeValue"
                                                        [placeholder]="property.description || ''" />
                                                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                                    <mat-datepicker #picker></mat-datepicker>
                                                </mat-form-field>
                                
                                                <!-- Fallback -->
                                                <span *ngSwitchDefault>{{ property.propertyType.value }}</span>
                                            </ng-container>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </ng-container>
                        <!-- selectedtab = 1 -->

<ng-container *ngIf="selectedTab === 1">
    <!-- Show +Add Update only when there are existing updates and the form is not open -->
    <div class="add_update_status mt-1" *ngIf="(EpicStatusUpdateList?.length || 0) > 0 && !showUpdateForm && !isEditable">
        <div class="status_button cursor-pointer" (click)="openUpdateForm()">+ Add Update</div>
    </div>
    
    <!-- Show update form when user opens it OR when there are no existing updates -->
    <div *ngIf="showUpdateForm || (EpicStatusUpdateList?.length || 0) === 0">
        <div class="update-card">
            <div class="status-container">
                <!-- Current Status -->
                <div class="status-pill"
                    [ngClass]="{ 'status-at-risk': selectedStatus.value === 'AT_RISK', 'status-off-track': selectedStatus.value === 'OFF_RISK' }"
                    (click)="$event.stopPropagation(); toggleDropdown(item)" tabindex="0" (keydown.enter)="$event.stopPropagation(); toggleDropdown(item)" style="cursor: pointer;">
                    <mat-icon class="status-icon d-flex align-items-center"
                        [ngStyle]="{ color: selectedStatus.color }">
                        {{ selectedStatus.icon }}
                    </mat-icon>
                    <span class="status-text">{{ selectedStatus.label }}</span>
                </div>

                <!-- Dropdown -->
                <div class="status-dropdown" *ngIf="isDropdownOpen" (click)="$event.stopPropagation()">
                    <div class="status-option" *ngFor="let status of statuses"
                        (click)="selectStatus(status)">
                        <mat-icon style="margin-top: 6px;"
                            [ngStyle]="{ color: status.color }">{{ status.icon }}</mat-icon>
                        <span>{{ status.label }}</span>
                    </div>
                </div>
            </div>

            <textarea class="update-input" rows="3" placeholder="Add your update here"
                [(ngModel)]="description"></textarea>
            <div class="actions p-1">
                <button class="cancel-btn" (click)="cancelUpdate()">Cancel</button>
                <button class="add-btn" (click)="createOnTrack()" [disabled]="isCreating">
                    {{ isCreating ? 'Saving...' : 'Create' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Cards Section -->
    <div class="vertical-container h-100" *ngIf="(EpicStatusUpdateList?.length || 0) > 0">
        <div class="card-container" *ngFor="let item of EpicStatusUpdateList">
            <!-- When not editing show the full read-only card (header + description + menu) -->
            <ng-container *ngIf="!item.isEditable; else editBlock">
                <div class="space-between" style="justify-content: space-between; display: flex;">
                    <div class="card-status-row">
                        <span class="status-badge">
                            <mat-icon class="status-icon" [ngStyle]="{ color: getStatusDetails(item.status)?.color }">
                                {{ getStatusDetails(item.status)?.icon }}
                            </mat-icon>
                            <span class="status-label" [ngStyle]="{ color: getStatusDetails(item.status)?.color }">{{ getStatusDetails(item.status).label }}</span>
                        </span>

                        <span class="card-date">
                            {{ item.updatedTimeStamp | date: 'short' }} • {{ item?.createdBy?.name || 'N/A' }}
                        </span>
                    </div>
                    <button class="menu-btn me-1" [matMenuTriggerFor]="menu" (click)="$event.stopPropagation()">
                        <mat-icon>more_horiz</mat-icon>
                    </button>
                </div>

                <div class="card-title">{{ item.description }}</div>
            </ng-container>

            <!-- When editing replace entire card with inline edit UI -->
            <ng-template #editBlock>
                <div class="edit-card full-edit">
                    <div class="d-flex align-items-start gap-2 mb-2">
                    <div class="status-pill" style="cursor: pointer;" tabindex="0"
                        (click)="toggleDropdown(item); $event.stopPropagation()"
                        (keydown.enter)="toggleDropdown(item); $event.stopPropagation()">
                            <mat-icon class="status-icon" [ngStyle]="{ color: getStatusDetails(selectedStatus.value || item.status)?.color }">
                                {{ getStatusDetails(selectedStatus.value || item.status)?.icon }}
                            </mat-icon>
                            <span class="status-text">{{ getStatusDetails(selectedStatus.value || item.status)?.label }}</span>
                        </div>

                        <div class="status-select-wrapper">
                           <div class="status-dropdown1" *ngIf="item.isDropdownOpen" (click)="$event.stopPropagation()">

                                <div class="status-option" *ngFor="let status of statuses" (click)="selectStatus(status); $event.stopPropagation();">
                                    <mat-icon style="margin-top: 6px;" [ngStyle]="{ color: status.color }">{{ status.icon }}</mat-icon>
                                    <span>{{ status.label }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <textarea class="update-input" rows="3" placeholder="Add your update here"
                        [(ngModel)]="description" (input)="autoResizeTextarea($event)"></textarea>
                    <div class="actions p-1 d-flex gap-2 justify-content-end">
                        <button class="cancel-btn btn btn-secondary" (click)="cancelEditItem(item)">Cancel</button>
                        <button class="add-btn btn btn-primary" (click)="submitEdit(item)">Save</button>
                    </div>
                </div>
            </ng-template>

                <!-- Card Menu -->
                <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="onEditEpicStatus(item)">
                        <mat-icon>edit</mat-icon>
                        <span>Edit</span>
                    </button>
                    <button mat-menu-item (click)="deleteTrack(item.id)">
                        <mat-icon>delete</mat-icon>
                        <span>Delete</span>
                    </button>
                </mat-menu>
        </div>
    </div>
</ng-container>

                        <!-- selectedtab = 2 -->
                        <ng-container *ngIf="selectedTab === 2">
                            <ng-container>
                                <div class="comment-section comment_height mt-2">
                                    <div class="comment-input customCommentInput h-100 d-flex flex-column">
                                        <quill-editor class="w-100 quillHeight" [modules]="editorConfig.modules"
                                            [placeholder]="editorConfig.placeholder" [theme]="editorConfig.theme"
                                            [(ngModel)]="editorContent"
                                            (onContentChanged)="onEditorContentChanged($event)"
                                            (onEditorCreated)="onEditorCreated($event)">
                                        </quill-editor>

                                        <!-- Custom Mention Popup -->
                                        <div *ngIf="showMentionPopup" class="mention-popup"
                                            [style.top.px]="mentionPosition.top" [style.left.px]="mentionPosition.left"
                                            (mousedown)="$event.preventDefault()">
                                            <div *ngFor="let member of filteredMembers" class="mention-popup-item"
                                                (click)="selectMention(member, $event)"
                                                (mousedown)="$event.preventDefault()">
                                                <div class="mention-name">{{ member.name || member.staffName }}</div>
                                            </div>
                                            <div *ngIf="filteredMembers?.length === 0"
                                                class="mention-popup-item no-results">
                                                No members found
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button class="comment-btn" (click)="!isSubmittingComment && sendComment()"
                                                [disabled]="isSubmittingComment"
                                                [style.pointer-events]="isSubmittingComment ? 'none' : 'auto'">
                                                <span *ngIf="isSubmittingComment"
                                                    class="spinner-border spinner-border-sm me-2" role="status"
                                                    aria-hidden="true"></span>
                                                {{ isSubmittingComment ? 'Commenting...' : 'Comment' }}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="activity-list epic_activity p-3">
                                    <div class="timeline">
                                        <ng-container *ngFor="let activity of commentList">
                                            <div class="timeline-item">
                                                <div class="timeline-icon" *ngIf="activity.type !== 'COMMENT'">
                                                    <i [ngClass]="getIconForActivityType(activity.type)"></i>
                                                </div>
                                                <div class="timeline-icon user-avatar"
                                                    *ngIf="activity.type === 'COMMENT'">
                                                    {{ getInitial(activity.createdBy?.name) }}
                                                </div>
                                                <div class="timeline-content w-100">
                                                    <div class="timeline-text mb-2">
                                                        <strong>{{ activity.createdBy?.name }}</strong>
                                                        <ng-container [ngSwitch]="activity.type">
                                                            <span *ngSwitchCase="'CREATED'">&nbsp;created the work
                                                                item.</span>
                                                            <span *ngSwitchCase="'UPDATED'">&nbsp;updated the work
                                                                item.</span>
                                                            <div *ngSwitchCase="'COMMENT'">
                                                                commented:
                                                                <div class="comment-display-container"
                                                                    *ngIf="activity.comment && activity.comment.trim()">
                                                                    <div class="comment-display-content"
                                                                        [innerHTML]="activity.comment" #commentContent>
                                                                    </div>
                                                                </div>
                                                                <div
                                                                    *ngIf="!activity.comment || !activity.comment.trim()"
                                                                    class="no-comment-text">
                                                                    <em>(no comment text)</em>
                                                                </div>
                                                                <div *ngIf="activity.assigneeOrMentions?.length"
                                                                    class="mentions">
                                                                    - mentioned
                                                                    <span
                                                                        *ngFor="let mention of activity.assigneeOrMentions; let last = last">
                                                                        <strong>{{ mention.name }}</strong><span
                                                                            *ngIf="!last">,
                                                                        </span>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <ng-container *ngSwitchCase="'TIME_LOGGED'">
                                                                <ng-container *ngIf="feature?.timeTracking">
                                                                    {{activity.message}}
                                                                    <div class="comment-display-container mt-2"
                                                                        *ngIf="activity.commentText && activity.commentText.trim()">
                                                                        <div class="comment-display-content"
                                                                            [innerHTML]="activity.commentText"
                                                                            #commentContent>
                                                                        </div>
                                                                    </div>
                                                                    <!-- <span *ngIf="!activity.commentText || !activity.commentText.trim()" class="no-comment-text">
                                                                        <em>(no Text)</em>
                                                                    </span> -->
                                                                </ng-container>
                                                            </ng-container>
                                                            <span *ngSwitchDefault>{{ activity.message }}</span>
                                                        </ng-container>
                                                        <span class="time">{{ getRelativeTime(activity.createdTimeStamp)
                                                            }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </ng-container>

                                        <!-- Show More/Show Less Button -->
                                        <div class="timeline-toggle text-center mt-3" *ngIf="hasMoreTimelineItems">
                                            <button class="btn btn-link timeline-toggle-btn"
                                                (click)="toggleShowAllTimeline()">
                                                <span *ngIf="!showAllTimeline">
                                                    <i class="fas fa-chevron-down me-1"></i>
                                                    Show all activities ({{ filteredTimelineCount - timelineDisplayLimit
                                                    }} more)
                                                </span>
                                                <span *ngIf="showAllTimeline">
                                                    <i class="fas fa-chevron-up me-1"></i>
                                                    Show less
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </ng-container>
                            <ng-template #commentsFirst>
                                <div class="comment-section  comment_height mt-3">
                                    <div class="comment-input customCommentInput h-100 d-flex flex-column">
                                        <quill-editor class="w-100 quillHeight" [modules]="editorConfig.modules"
                                            [placeholder]="editorConfig.placeholder" [theme]="editorConfig.theme"
                                            [(ngModel)]="editorContent"
                                            (onContentChanged)="onEditorContentChanged($event)"
                                            (onEditorCreated)="onEditorCreated($event)">
                                        </quill-editor>

                                        <!-- Custom Mention Popup -->
                                        <div *ngIf="showMentionPopup" class="mention-popup"
                                            [style.top.px]="mentionPosition.top" [style.left.px]="mentionPosition.left"
                                            (mousedown)="$event.preventDefault()">
                                            <div *ngFor="let member of filteredMembers" class="mention-popup-item"
                                                (click)="selectMention(member, $event)"
                                                (mousedown)="$event.preventDefault()">
                                                <div class="mention-name">{{ member.name || member.staffName }}</div>
                                            </div>
                                            <div *ngIf="filteredMembers?.length === 0"
                                                class="mention-popup-item no-results">
                                                No members found
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button class="comment-btn"
                                                (click)="!isSubmittingComment && submitComment()"
                                                [disabled]="isSubmittingComment"
                                                [style.pointer-events]="isSubmittingComment ? 'none' : 'auto'">
                                                <span *ngIf="isSubmittingComment"
                                                    class="spinner-border spinner-border-sm me-2" role="status"
                                                    aria-hidden="true"></span>
                                                {{ isSubmittingComment ? 'Commenting...' : 'Comment' }}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="activity-list epic_activity p-3">
                                    <div class="timeline">
                                        <ng-container *ngFor="let activity of commentList">
                                            <div class="timeline-item">
                                                <div class="timeline-icon" *ngIf="activity.type !== 'COMMENT'">
                                                    <i [ngClass]="getIconForActivityType(activity.type)"></i>
                                                </div>
                                                <div class="timeline-icon user-avatar"
                                                    *ngIf="activity.type === 'COMMENT'">
                                                    {{ getInitial(activity.createdBy?.name) }}
                                                </div>
                                                <div class="timeline-content w-100">
                                                    <div class="timeline-text mb-2">
                                                        <strong>{{ activity.createdBy?.name }}</strong>
                                                        <ng-container [ngSwitch]="activity.type">
                                                            <span *ngSwitchCase="'CREATED'">&nbsp;created the work
                                                                item.</span>
                                                            <span *ngSwitchCase="'UPDATED'">&nbsp;updated the work
                                                                item.</span>
                                                            <div *ngSwitchCase="'COMMENT'">
                                                                commented:
                                                                <div class="comment-display-container"
                                                                    *ngIf="activity.comment && activity.comment.trim()">
                                                                    <div class="comment-display-content"
                                                                        [innerHTML]="activity.comment" #commentContent>
                                                                    </div>
                                                                </div>
                                                                <div
                                                                    *ngIf="!activity.comment || !activity.comment.trim()"
                                                                    class="no-comment-text">
                                                                    <em>(no comment text)</em>
                                                                </div>
                                                                <div *ngIf="activity.assigneeOrMentions?.length"
                                                                    class="mentions">
                                                                    - mentioned
                                                                    <span
                                                                        *ngFor="let mention of activity.assigneeOrMentions; let last = last">
                                                                        <strong>{{ mention.name }}</strong><span
                                                                            *ngIf="!last">,
                                                                        </span>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <ng-container *ngSwitchCase="'TIME_LOGGED'">
                                                                <ng-container *ngIf="feature?.timeTracking">
                                                                    {{activity.message}}
                                                                    <div class="comment-display-container mt-2"
                                                                        *ngIf="activity.commentText && activity.commentText.trim()">
                                                                        <div class="comment-display-content"
                                                                            [innerHTML]="activity.commentText"
                                                                            #commentContent>
                                                                        </div>
                                                                    </div>
                                                                    <!-- <span *ngIf="!activity.commentText || !activity.commentText.trim()" class="no-comment-text">
                                                                        <em>(no Text)</em>
                                                                    </span> -->
                                                                </ng-container>
                                                            </ng-container>
                                                            <span *ngSwitchDefault>{{ activity.message }}</span>
                                                        </ng-container>
                                                        <span class="time">{{ getRelativeTime(activity.createdTimeStamp)
                                                            }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </ng-container>

                                        <!-- Show More/Show Less Button -->
                                        <div class="timeline-toggle text-center mt-3" *ngIf="hasMoreTimelineItems">
                                            <button class="btn btn-link timeline-toggle-btn"
                                                (click)="toggleShowAllTimeline()">
                                                <span *ngIf="!showAllTimeline">
                                                    <i class="fas fa-chevron-down me-1"></i>
                                                    Show all activities ({{ filteredTimelineCount - timelineDisplayLimit
                                                    }} more)
                                                </span>
                                                <span *ngIf="showAllTimeline">
                                                    <i class="fas fa-chevron-up me-1"></i>
                                                    Show less
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </ng-template>
                        </ng-container>
                        <!-- selectedtab = 3 -->
                        <ng-container *ngIf="selectedTab === 3">
                            <div class="activity-container">
                                <div class="activity-header">Activity</div>
                                <div class="activity-list">
                                    <div class="activity-row">
                                        <mat-icon class="activity-icon" aria-hidden="true">cloud</mat-icon>
                                        <div>
                                            <span class="user-bold">sangepushiva1999</span>
                                            <span class="user_desc"> created the epic.</span>

                                            <div class="activity-time">1 day ago</div>
                                        </div>
                                    </div>
                                    <div class="activity-row">
                                        <mat-icon class="activity-icon" aria-hidden="true">link</mat-icon>
                                        <div>
                                            <span class="user-bold">sangepushiva1999</span>
                                            <span class="user_desc"> marked that this work item relates to
                                                ORRA-7.</span>
                                            <div class="activity-time">about 9 hours ago</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </ng-container>
                    </div>
                </ng-container>
            </div>
            <div class="properties p-3" *ngIf="fromScreen !== 'EPIC' ">
                <ng-container *ngIf="fromScreen !== 'EPIC' ">
                    <h3 class="properties-title mb-3">Properties</h3>
                    <div class="properties-list d-flex flex-column gap-3">
                        <div class="property-item d-flex align-items-center gap-2" (click)="onStateEdit($event)"
                            style="cursor: pointer;">
                            <mat-icon>radio_button_checked</mat-icon>
                            <span class="property-label">State</span>
                            <span class="property-value">{{ wholeData?.state?.name || 'N/A' }}</span>
                        </div>
                        <ng-template #noAssignee>
                            <div class="property-item d-flex align-items-center gap-2" (click)="onAssigneeEdit($event)"
                                style="cursor: pointer;">
                                <mat-icon>person</mat-icon>
                                <span class="property-label">Assignees</span>
                                <span class="property-value text-muted">No assignees</span>
                            </div>
                        </ng-template>
                        <div class="property-item d-flex align-items-center gap-2"
                            *ngIf="wholeData?.assignee?.length; else noAssignee" (click)="onAssigneeEdit($event)"
                            style="cursor: pointer;">
                            <mat-icon>person</mat-icon>
                            <span class="property-label">Assignees</span>
                            <div class="assignee-list d-flex flex-wrap gap-1">
                                <span class="assignee-tag" *ngFor="let assignee of wholeData.assignee">
                                    {{assignee.name}}
                                    <span class="remove-icon" (click)="removeAssignee(assignee, $event)">×</span>
                                </span>
                            </div>
                        </div>
                        <div class="property-item d-flex align-items-center gap-2" (click)="onPriorityEdit($event)"
                            style="cursor: pointer;">
                            <mat-icon>signal_cellular_alt</mat-icon>
                            <span class="property-label">Priority</span>
                            <span class="property-value">{{ wholeData?.priority || 'None' }}</span>
                        </div>
                        <div class="property-item d-flex align-items-center gap-2">
                            <mat-icon>person_outline</mat-icon>
                            <span class="property-label">Created by</span>
                            <div class="user-info d-flex align-items-center gap-2">
                                <div class="user-avatar">{{getInitial(wholeData?.createdBy?.name)}}</div>
                                <span>{{wholeData?.createdBy?.name || 'None'}}</span>
                            </div>
                        </div>
                        <div class="property-item d-flex align-items-center gap-2" (click)="onStartDateEdit($event)"
                            style="cursor: pointer;">
                            <mat-icon>calendar_today</mat-icon>
                            <span class="property-label">Start date</span>
                            <span class="property-value">{{ (wholeData?.startDate | date: 'MMM d y') || 'None' }}</span>
                            <span class="remove-icon" *ngIf="wholeData?.startDate" (click)="removeDate('startDate', $event)">×</span>
                        </div>
                        <div class="property-item d-flex align-items-center gap-2" (click)="onDueDateEdit($event)"
                            style="cursor: pointer;">
                            <mat-icon>event</mat-icon>
                            <span class="property-label">Due date</span>
                            <span class="property-value text-danger">{{ (wholeData?.endDate | date: 'MMM d y') ||
                                'None'}}</span>
                            <span class="remove-icon" *ngIf="wholeData?.endDate" (click)="removeDate('endDate', $event)">×</span>
                        </div>
                        <div class="property-item d-flex align-items-center gap-2" (click)="onReleaseDateEdit($event)" style="cursor: pointer;">
                            <mat-icon>calendar_today</mat-icon>
                            <span class="property-label">Release date</span>
                            <span class="property-value text-muted ">{{ (wholeData?.releaseDate | date: 'MMM d y') || 'N/A' }}</span>
                        </div>
                        <div *ngIf="feature?.modules" class="property-item d-flex align-items-center gap-2"
                            (click)="onModuleEdit($event)" style="cursor: pointer;">
                            <mat-icon>dashboard</mat-icon>
                            <span class="property-label">Modules</span>
                            <span class="property-value text-muted">{{ wholeData?.modules?.name || 'None' }}</span>
                        </div>
                        <div *ngIf="feature?.cycles" class="property-item d-flex align-items-center gap-2"
                            (click)="onCycleEdit($event)" style="cursor: pointer;">
                            <mat-icon>refresh</mat-icon>
                            <span class="property-label">Cycle</span>
                            <span class="property-value text-muted">{{ wholeData?.cycle?.name || 'None' }}</span>
                        </div>
                        <!-- <div class="property-item d-flex align-items-center gap-2" (click)="onParentEdit($event)" style="cursor: pointer;">
                    <mat-icon>account_tree</mat-icon>
                    <span class="property-label">Parent</span>
                    <span class="property-value text-muted">{{ wholeData?.parent || 'Add parent work item' }}</span>
                </div> -->
                        <div class="property-item d-flex align-items-center gap-2" (click)="onLabelEdit($event)"
                            style="cursor: pointer;">
                            <mat-icon>label</mat-icon>
                            <span class="property-label">Labels</span>
                            <div class="labels-list d-flex flex-wrap gap-1">
                                <span *ngFor="let label of wholeData?.label" class="label-tag">
                                    {{label?.name || label?.label}}
                                    <span class="remove-icon" (click)="removeLabel(label, $event)">×</span>
                                </span>
                                <span *ngIf="!wholeData?.label || wholeData?.label?.length === 0" class="no-label">
                                    None
                                </span>
                            </div>
                        </div>
                        <div *ngIf="feature?.estimations" class="property-item d-flex align-items-center gap-2"
                            (click)="onEstimateTime($event)" style="cursor: pointer;">
                            <mat-icon>schedule</mat-icon>
                            <span class="property-label">Estimate</span>
                            <span class="property-value">{{ formatEstimatedList(wholeData?.estimate) || 'None' }}</span>
                        </div>
                        <div *ngIf="feature?.timeTracking" class="property-item d-flex align-items-center gap-2"
                            style="cursor: pointer;">
                            <mat-icon>timer</mat-icon>
                            <span class="property-label">Time Tracking</span>
                            <span class="property-value">{{totalTime}}</span>
                        </div>
                    </div>
                </ng-container>

            </div>
            <div *ngIf="fromScreen !== 'EPIC' " class="activity p-3">
                <div class="activity-header d-flex justify-content-between align-items-center mb-3">
                    <h3 class="activity-title">Activity</h3>
                    <div class="left_section d-flex align-items-center gap-2">
                        <div *ngIf="feature?.timeTracking" class="logwork-wrapper" (click)="$event.stopPropagation()">
                            <button class="log_btn" (click)="openLogWorkDialog($event)">+ Log Work</button>
                            <div class="lw-popover" *ngIf="showLogWorkPopup">
                                <div class="lw-header-pill">
                                    <span class="lw-timer">⏱</span>
                                    <span style="font-size: 12px;">{{ logHeaderLabel }}</span>
                                </div>
                                <div class="lw-split-group">
                                    <input type="number" placeholder="Hours" min="0" [ngModel]="logHours"
                                        (ngModelChange)="onHoursChange($event)"
                                        [class.invalid]="logHours === 0 && logMinutes === 0">
                                    <span class="lw-divider"></span>
                                    <input type="number" placeholder="Minutes" min="0" max="59" [ngModel]="logMinutes"
                                        (ngModelChange)="onMinutesChange($event)"
                                        [class.invalid]="logHours === 0 && logMinutes === 0">
                                </div>
                                <textarea class="lw-desc" placeholder="Description" [(ngModel)]="logDescription"
                                    [class.invalid]="!logDescription || logDescription.trim().length === 0"></textarea>
                                <div class="lw-actions">
                                    <button class="lw-btn-cancel" (click)="closeLogWorkDialog()">Cancel</button>
                                    <button class="lw-btn-save" (click)="saveLogWork()" [disabled]="!isLogWorkValid"
                                        [class.disabled]="!isLogWorkValid">Save</button>
                                </div>
                            </div>
                        </div>
                        <div class="Activity_toggle">
                            <button class="toggle_btn d-flex align-items-center p-0" (click)="swapSections()">
                                <ng-container *ngIf="isTimelineTop; else upwardIcon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="lucide lucide-arrow-down-wide-narrow size-4">
                                        <path d="m3 16 4 4 4-4"></path>
                                        <path d="M7 20V4"></path>
                                        <path d="M11 4h10"></path>
                                        <path d="M11 8h7"></path>
                                        <path d="M11 12h4"></path>
                                    </svg>
                                </ng-container>
                                <ng-template #upwardIcon>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="lucide lucide-arrow-up-wide-narrow size-4">
                                        <path d="m3 8 4-4 4 4"></path>
                                        <path d="M7 4v16"></path>
                                        <path d="M11 12h10"></path>
                                        <path d="M11 16h7"></path>
                                        <path d="M11 20h4"></path>
                                    </svg>
                                </ng-template>
                            </button>

                        </div>
                        <div class="link-menu" #menuWrapper>
                            <!-- <button class="menu-btn" (click)="toggleMenu(i)" (click)="$event.stopPropagation()">
                                                            <i class="fas fa-ellipsis-h"></i>
                                                        </button> -->
                            <button class="filter-btn d-flex align-items-center gap-1"
                                (click)="toggleFilterMenu($event)">
                                <mat-icon>filter_list</mat-icon>
                                Filters
                            </button>
                            <div class="menu-dropdown" [class.show]="isFilterMenuOpen"
                                (click)="$event.stopPropagation()">
                                <a class="menu-item" (click)="toggleFilter('updates')">
                                    <span class="check" [class.checked]="filterOptions.updates"></span>
                                    Updates
                                </a>
                                <a class="menu-item" (click)="toggleFilter('comments')">
                                    <span class="check" [class.checked]="filterOptions.comments"></span>
                                    Comments
                                </a>
                                <a *ngIf="feature?.timeTracking" class="menu-item" (click)="toggleFilter('worklogs')">
                                    <span class="check" [class.checked]="filterOptions.worklogs"></span>
                                    Worklogs
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <ng-container *ngIf="isTimelineTop; else commentsFirst">
                    <div class="activity-list p-3">
                        <div class="timeline">
                            <ng-container *ngFor="let activity of displayedTimelineData">
                                <div class="timeline-item">
                                    <div class="timeline-icon" *ngIf="activity.type !== 'COMMENTED'">
                                        <i [ngClass]="getIconForActivityType(activity.type)"></i>
                                    </div>
                                    <div class="timeline-icon user-avatar" *ngIf="activity.type === 'COMMENTED'">
                                        {{ getInitial(activity.user?.name) }}
                                    </div>
                                    <div class="timeline-content w-100">
                                        <div class="timeline-text mb-2">
                                            <strong>{{ activity.user?.name }}</strong>
                                            <ng-container [ngSwitch]="activity.type">
                                                <span *ngSwitchCase="'CREATED'">&nbsp;created the work item.</span>
                                                <span *ngSwitchCase="'UPDATED'">&nbsp;updated the work item.</span>
                                                <div *ngSwitchCase="'COMMENTED'">
                                                    commented:
                                                    <div class="comment-display-container"
                                                        *ngIf="activity.commentText && activity.commentText.trim()">
                                                        <div class="comment-display-content"
                                                            [innerHTML]="activity.commentText" #commentContent>
                                                        </div>
                                                    </div>
                                                    <div *ngIf="!activity.commentText || !activity.commentText.trim()"
                                                        class="no-comment-text">
                                                        <em>(no comment text)</em>
                                                    </div>
                                                    <div *ngIf="activity.assigneeOrMentions?.length" class="mentions">
                                                        - mentioned
                                                        <span
                                                            *ngFor="let mention of activity.assigneeOrMentions; let last = last">
                                                            <strong>{{ mention.name }}</strong><span *ngIf="!last">,
                                                            </span>
                                                        </span>
                                                    </div>
                                                </div>
                                                <ng-container *ngSwitchCase="'TIME_LOGGED'">
                                                    <ng-container *ngIf="feature?.timeTracking">
                                                        {{activity.message}}
                                                        <div class="comment-display-container mt-2"
                                                            *ngIf="activity.commentText && activity.commentText.trim()">
                                                            <div class="comment-display-content"
                                                                [innerHTML]="activity.commentText" #commentContent>
                                                            </div>
                                                        </div>
                                                        <!-- <span *ngIf="!activity.commentText || !activity.commentText.trim()" class="no-comment-text">
                                                        <em>(no Text)</em>
                                                    </span> -->
                                                    </ng-container>
                                                </ng-container>
                                                <span *ngSwitchDefault>{{ activity.message }}</span>
                                            </ng-container>
                                            <span class="time">{{ getRelativeTime(activity.timestamp) }}</span>
                                            </div>
                                    </div>
                                </div>
                            </ng-container>

                            <!-- Show More/Show Less Button -->
                            <div class="timeline-toggle text-center mt-3" *ngIf="hasMoreTimelineItems">
                                <button class="btn btn-link timeline-toggle-btn" (click)="toggleShowAllTimeline()">
                                    <span *ngIf="!showAllTimeline">
                                        <i class="fas fa-chevron-down me-1"></i>
                                        Show all activities ({{ filteredTimelineCount - timelineDisplayLimit }} more)
                                    </span>
                                    <span *ngIf="showAllTimeline">
                                        <i class="fas fa-chevron-up me-1"></i>
                                        Show less
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="comment-section mt-3">
                        <div class="comment-input">
                            <quill-editor class="w-100" [modules]="editorConfig.modules"
                                [placeholder]="editorConfig.placeholder" [theme]="editorConfig.theme"
                                [(ngModel)]="editorContent" (onContentChanged)="onEditorContentChanged($event)"
                                (onEditorCreated)="onEditorCreated($event)">
                            </quill-editor>

                            <!-- Custom Mention Popup -->
                            <div *ngIf="showMentionPopup" class="mention-popup" [style.top.px]="mentionPosition.top"
                                [style.left.px]="mentionPosition.left" (mousedown)="$event.preventDefault()">
                                <div *ngFor="let member of filteredMembers" class="mention-popup-item"
                                    (click)="selectMention(member, $event)" (mousedown)="$event.preventDefault()">
                                    <div class="mention-name">{{ member.name || member.staffName }}</div>
                                </div>
                                <div *ngIf="filteredMembers?.length === 0" class="mention-popup-item no-results">
                                    No members found
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button class="comment-btn" (click)="!isSubmittingComment && submitComment()"
                                    [disabled]="isSubmittingComment"
                                    [style.pointer-events]="isSubmittingComment ? 'none' : 'auto'">
                                    <span *ngIf="isSubmittingComment" class="spinner-border spinner-border-sm me-2"
                                        role="status" aria-hidden="true"></span>
                                    {{ isSubmittingComment ? 'Commenting...' : 'Comment' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </ng-container>
                <ng-template #commentsFirst>
                    <div class="comment-section mt-3">
                        <div class="comment-input">
                            <quill-editor class="w-100" [modules]="editorConfig.modules"
                                [placeholder]="editorConfig.placeholder" [theme]="editorConfig.theme"
                                [ngModel]="editorContent" (ngModelChange)="editorContent = $event"
                                (onContentChanged)="onEditorContentChanged($event)"
                                (onEditorCreated)="onEditorCreated($event)">
                            </quill-editor>

                            <!-- Custom Mention Popup -->
                            <div *ngIf="showMentionPopup" class="mention-popup" [style.top.px]="mentionPosition.top"
                                [style.left.px]="mentionPosition.left" (mousedown)="$event.preventDefault()">
                                <div *ngFor="let member of filteredMembers" class="mention-popup-item"
                                    (click)="selectMention(member, $event)" (mousedown)="$event.preventDefault()">
                                    <div class="mention-name">{{ member.name || member.staffName }}</div>
                                </div>
                                <div *ngIf="filteredMembers?.length === 0" class="mention-popup-item no-results">
                                    No members found
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button class="comment-btn" (click)="!isSubmittingComment && submitComment()"
                                    [disabled]="isSubmittingComment"
                                    [style.pointer-events]="isSubmittingComment ? 'none' : 'auto'">
                                    <span *ngIf="isSubmittingComment" class="spinner-border spinner-border-sm me-2"
                                        role="status" aria-hidden="true"></span>
                                    {{ isSubmittingComment ? 'Commenting...' : 'Comment' }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="activity-list p-3">
                        <div class="timeline">
                            <ng-container *ngFor="let activity of displayedTimelineData">
                                <div class="timeline-item">
                                    <div class="timeline-icon" *ngIf="activity.type !== 'COMMENTED'">
                                        <i [ngClass]="getIconForActivityType(activity.type)"></i>
                                    </div>
                                    <div class="timeline-icon user-avatar" *ngIf="activity.type === 'COMMENTED'">
                                        {{ getInitial(activity.user?.name) }}
                                    </div>
                                    <div class="timeline-content w-100">
                                        <div class="timeline-text mb-2">
                                            <strong>{{ activity.user?.name }}</strong>
                                            <ng-container [ngSwitch]="activity.type">
                                                <span *ngSwitchCase="'CREATED'">&nbsp;created the work item.</span>
                                                <span *ngSwitchCase="'UPDATED'">&nbsp;updated the work item.</span>
                                                <span *ngSwitchCase="'COMMENTED'">
                                                    commented:
                                                    <div class="comment-display-container"
                                                        *ngIf="activity.commentText && activity.commentText.trim()">
                                                        <div class="comment-display-content"
                                                            [innerHTML]="activity.commentText" #commentContent>
                                                        </div>
                                                    </div>
                                                    <span *ngIf="!activity.commentText || !activity.commentText.trim()"
                                                        class="no-comment-text">
                                                        <em>(no comment text)</em>
                                                    </span>
                                                    <span *ngIf="activity.assigneeOrMentions?.length" class="mentions">
                                                        - mentioned
                                                        <span
                                                            *ngFor="let mention of activity.assigneeOrMentions; let last = last">
                                                            <strong>{{ mention.name }}</strong><span *ngIf="!last">,
                                                            </span>
                                                        </span>
                                                    </span>
                                                </span>
                                                <ng-container *ngSwitchCase="'TIME_LOGGED'">
                                                    <ng-container *ngIf="feature?.timeTracking">
                                                        {{activity.message}}
                                                        <div class="comment-display-container mt-2"
                                                            *ngIf="activity.commentText && activity.commentText.trim()">
                                                            <div class="comment-display-content"
                                                                [innerHTML]="activity.commentText" #commentContent>
                                                            </div>
                                                        </div>
                                                        <!-- <span *ngIf="!activity.commentText || !activity.commentText.trim()" class="no-comment-text">
                                                        <em>(no Text)</em>
                                                    </span> -->
                                                    </ng-container>
                                                </ng-container>
                                                <span *ngSwitchDefault>{{ activity.message }}</span>
                                            </ng-container>
                                            <span class="time">{{ getRelativeTime(activity.timestamp) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </ng-container>

                            <!-- Show More/Show Less Button -->
                            <div class="timeline-toggle text-center mt-3" *ngIf="hasMoreTimelineItems">
                                <button class="btn btn-link timeline-toggle-btn" (click)="toggleShowAllTimeline()">
                                    <span *ngIf="!showAllTimeline">
                                        <i class="fas fa-chevron-down me-1"></i>
                                        Show all activities ({{ filteredTimelineCount - timelineDisplayLimit }} more)
                                    </span>
                                    <span *ngIf="showAllTimeline">
                                        <i class="fas fa-chevron-up me-1"></i>
                                        Show less
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </ng-template>

            </div>
        </div>

    </div>

</div>

<!-- Image Preview Modal -->
<div class="image-preview-modal" *ngIf="showImagePreview" (click)="closeImagePreview()">
    <div class="modal-backdrop"></div>
    <div class="preview-container" (click)="$event.stopPropagation()">
        <div class="preview-header d-flex justify-content-between align-items-center">
            <h4 class="preview-title">
                <span *ngIf="isImageFile(selectedAttachment?.name)">Image Preview: </span>
                <span *ngIf="isVideoFile(selectedAttachment?.name)">Video Preview: </span>
                <span *ngIf="isPdfFile(selectedAttachment?.name)">PDF Preview: </span>
                <span
                    *ngIf="!isImageFile(selectedAttachment?.name) && !isVideoFile(selectedAttachment?.name) && !isPdfFile(selectedAttachment?.name)">File
                    Preview: </span>
                {{selectedAttachment?.name}}
            </h4>
            <button class="close-btn" (click)="closeImagePreview()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
        <div class="preview-content">
            <!-- Image Preview -->
            <div class="preview-image-container" *ngIf="isImageFile(selectedAttachment?.name)">
                <img [src]="getAttachmentUrl(selectedAttachment)" alt="{{selectedAttachment?.name}}"
                    class="preview-image">
            </div>

            <!-- Video Preview -->
            <div class="preview-video-container" *ngIf="isVideoFile(selectedAttachment?.name)">
                <video controls class="preview-video" [src]="getAttachmentUrl(selectedAttachment)">
                    <p>Your browser does not support the video tag or the video format.</p>
                    <a [href]="getAttachmentUrl(selectedAttachment)" target="_blank" rel="noopener noreferrer">
                        Download video file
                    </a>
                </video>
            </div>

            <!-- PDF Preview -->
            <div class="preview-pdf-container" *ngIf="isPdfFile(selectedAttachment?.name)">
                <div class="file-preview-icon">
                    <mat-icon class="large-icon">picture_as_pdf</mat-icon>
                </div>
                <p class="file-info-text">{{selectedAttachment?.name}}</p>
                <div class="pdf-actions">
                    <button class="btn btn-primary me-2" (click)="openFileInNewTab(selectedAttachment)">
                        <mat-icon>open_in_new</mat-icon> Open PDF in New Tab
                    </button>
                    <button class="btn btn-secondary" (click)="downloadAttachment(selectedAttachment)">
                        <mat-icon>download</mat-icon> Download
                    </button>
                </div>
            </div>

            <!-- Document/Other Files Preview -->
            <div class="preview-file-container"
                *ngIf="!isImageFile(selectedAttachment?.name) && !isVideoFile(selectedAttachment?.name) && !isPdfFile(selectedAttachment?.name)">
                <div class="file-preview-icon">
                    <mat-icon *ngIf="isDocFile(selectedAttachment?.name)" class="large-icon">description</mat-icon>
                    <mat-icon *ngIf="!isDocFile(selectedAttachment?.name)" class="large-icon">attach_file</mat-icon>
                </div>
                <p class="file-info-text">{{selectedAttachment?.name}}</p>
                <button class="btn btn-primary" (click)="downloadAttachment(selectedAttachment)">
                    <mat-icon>download</mat-icon> Download
                </button>
            </div>
        </div>
        <div class="preview-footer">
            <div class="file-details">
                <!-- <p><strong>Size:</strong> {{formatFileSize(selectedAttachment?.size)}}</p> -->
                <p><strong>Uploaded by:</strong> {{selectedAttachment?.staff?.name || selectedAttachment?.uploadedBy ||
                    'Unknown'}}</p>
                <p><strong>Date:</strong> {{selectedAttachment?.date | date:'short'}}</p>
            </div>
        </div>
    </div>
</div>